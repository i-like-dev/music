<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🎵 進階 YouTube 播放器 🎶</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Noto Sans TC', sans-serif;
    background: #fff;
    color: #222;
    text-align: center;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    user-select: none;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  h1 {
    font-size: 2.4rem;
    margin-bottom: 1rem;
    font-weight: normal;
  }
  #time, #idleTime {
    font-weight: 400;
    margin-bottom: 20px;
    color: #555;
  }
  #time {
    font-size: 1.1rem;
  }
  #idleTime {
    font-size: 5rem;
    display: none;
    user-select: none;
  }
  #player {
    width: 0;
    height: 0;
    position: absolute;
    left: -9999px;
  }
  #playlist {
    list-style: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }
  #playlist li {
    background: #f0f8ff;
    border: 1px solid #0088ff;
    border-radius: 10px;
    padding: 12px 16px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 400;
    width: calc(50% - 12px);
    box-sizing: border-box;
    transition: background-color 0.3s ease, color 0.3s ease;
    color: #0088ff;
    user-select: none;
  }
  #playlist li:hover {
    background-color: #cce6ff;
  }
  #playlist li.active {
    background-color: #0088ff;
    color: white;
  }
  .controls {
    margin-bottom: 15px;
  }
  .controls button {
    background-color: #0088ff;
    border: none;
    color: white;
    padding: 12px 20px;
    margin: 0 7px 10px 7px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 700;
    box-shadow: 0 4px 10px rgb(0 136 255 / 0.5);
    transition: background-color 0.3s ease;
    user-select: none;
  }
  .controls button:hover {
    background-color: #006fcc;
  }
  label {
    font-weight: 600;
    vertical-align: middle;
  }
  #volumeContainer {
    margin-top: 8px;
  }
  input[type=range] {
    vertical-align: middle;
    width: 100%;
    max-width: 300px;
    cursor: pointer;
    margin-top: 6px;
  }
  #progressContainer {
    margin: 15px 0 25px;
  }
  #progress {
    width: 100%;
    height: 12px;
    -webkit-appearance: none;
    appearance: none;
    background: #e2e2e2;
    border-radius: 10px;
    cursor: pointer;
  }
  #progress::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #0088ff;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px #006fcc;
    margin-top: -4px;
  }
  #progress::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #0088ff;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px #006fcc;
  }
  #autoPauseContainer {
    margin-top: 20px;
    font-size: 0.95rem;
    color: #444;
    user-select: none;
  }
  #autoPauseInput {
    width: 50px;
    padding: 4px;
    margin-left: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
  }
  #currentTimeDisplay {
    font-weight: 400;
    font-size: 1rem;
    margin-bottom: 10px;
    color: #333;
    user-select: none;
  }
</style>
</head>
<body>

<h1>🎵 進階 YouTube 播放器 🎶</h1>
<div id="time">⌚ 現在時間：--:--:--</div>
<div id="idleTime"></div>

<ul id="playlist">載入中…</ul>

<div class="controls">
  <button id="prevBtn">⏮️ 上一首</button>
  <button id="playPauseBtn">▶️ 播放</button>
  <button id="nextBtn">⏭️ 下一首</button>
  <button id="fullscreenBtn">🖥️ 全螢幕</button>
  
  <div id="volumeContainer">
    <label for="volumeRange">🔊 音量</label><br/>
    <input type="range" id="volumeRange" min="0" max="100" value="50" />
  </div>
</div>

<div id="progressContainer">
  <input type="range" id="progress" min="0" max="100" value="0" />
  <div id="currentTimeDisplay">00:00:00 / 00:00:00</div>
</div>

<div id="autoPauseContainer">
  ⏸️ 自動暫停秒數（0 不啟用）:
  <input type="number" id="autoPauseInput" min="0" max="3600" value="0" /> 秒
</div>

<div id="player"></div>

<script>
  const PLAYLIST_ID = 'PL4Ty6N3yT5CLyiCIDeHaDqNUgFEXWr9oW';
  const API_KEY = 'AIzaSyAcViF7zlpVqJH20M1RucGmt7RoIb_isuA';

  let player;
  let currentIndex = 0;
  let isPlaying = false;
  let autoPauseSeconds = 0;
  let autoPauseTimer = null;

  const playlistElement = document.getElementById('playlist');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const volumeRange = document.getElementById('volumeRange');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const timeElement = document.getElementById('time');
  const idleTimeElement = document.getElementById('idleTime');
  const progress = document.getElementById('progress');
  const autoPauseInput = document.getElementById('autoPauseInput');
  const currentTimeDisplay = document.getElementById('currentTimeDisplay');
  const fullscreenBtn = document.getElementById('fullscreenBtn');

  let videos = [];

  // Idle mode (待機模式)
  let idleTimeout = null;
  const IDLE_DELAY = 60000;
  let isIdle = false;

  function resetIdleTimer() {
    if (isIdle) {
      exitIdleMode();
    }
    clearTimeout(idleTimeout);
    idleTimeout = setTimeout(enterIdleMode, IDLE_DELAY);
  }

  function enterIdleMode() {
    isIdle = true;
    document.body.style.backgroundColor = '#222';
    document.body.style.color = '#0ff';
    playlistElement.style.display = 'none';
    document.querySelector('.controls').style.display = 'none';
    progress.style.display = 'none';
    timeElement.style.display = 'none';
    currentTimeDisplay.style.display = 'none';

    idleTimeElement.style.display = 'block';
  }

  function exitIdleMode() {
    isIdle = false;
    document.body.style.backgroundColor = '#fff';
    document.body.style.color = '#222';
    playlistElement.style.display = '';
    document.querySelector('.controls').style.display = '';
    progress.style.display = '';
    timeElement.style.display = '';
    currentTimeDisplay.style.display = '';

    idleTimeElement.style.display = 'none';
  }

  document.addEventListener('mousemove', resetIdleTimer);
  document.addEventListener('keydown', resetIdleTimer);
  resetIdleTimer();

  function updateIdleTime() {
    if (!isIdle) return;
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    idleTimeElement.textContent = `${hh}:${mm}:${ss}`;
  }
  setInterval(updateIdleTime, 1000);

  async function fetchPlaylistVideos(playlistId) {
    let videos = [];
    let nextPageToken = '';
    do {
      const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${API_KEY}&pageToken=${nextPageToken}`);
      const data = await res.json();
      if (data.error) {
        alert('取得播放清單錯誤: ' + data.error.message);
        return [];
      }
      videos.push(...data.items);
      nextPageToken = data.nextPageToken || '';
    } while (nextPageToken);
    return videos.map(item => ({
      videoId: item.snippet.resourceId.videoId,
      title: '🎶 ' + item.snippet.title
    }));
  }

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height: '0',
      width: '0',
      playerVars: {
        playsinline: 1,
        controls: 0,
        disablekb: 1,
        modestbranding: 1,
        rel: 0
      },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange
      }
    });
  }

  function onPlayerReady() {
    player.setVolume(volumeRange.value);
    renderPlaylist();
    loadVideo(currentIndex);
    updateProgress();
  }

  function onPlayerStateChange(event) {
    if (event.data === YT.PlayerState.ENDED) {
      next();
    }
    resetAutoPauseTimer();
  }

  function renderPlaylist() {
    playlistElement.innerHTML = '';
    videos.forEach((video, idx) => {
      const li = document.createElement('li');
      li.textContent = video.title;
      li.dataset.index = idx;
      if (idx === currentIndex) li.classList.add('active');
      li.addEventListener('click', () => {
        loadVideo(idx);
        play();
      });
      playlistElement.appendChild(li);
    });
  }

  function loadVideo(index) {
    currentIndex = index;
    player.loadVideoById(videos[index].videoId);
    updateActiveItem();
  }

  function updateActiveItem() {
    const lis = playlistElement.querySelectorAll('li');
    lis.forEach(li => li.classList.remove('active'));
    const currentLi = playlistElement.querySelector(`li[data-index="${currentIndex}"]`);
    if (currentLi) currentLi.classList.add('active');
  }

  function play() {
    player.playVideo();
    isPlaying = true;
    playPauseBtn.textContent = '⏸️ 暫停';
    resetAutoPauseTimer();
  }

  function pause() {
    player.pauseVideo();
    isPlaying = false;
    playPauseBtn.textContent = '▶️ 播放';
    clearTimeout(autoPauseTimer);
  }

  function togglePlayPause() {
    if (!player) return;
    if (isPlaying) pause();
    else play();
  }

  function next() {
    currentIndex = (currentIndex + 1) % videos.length;
    loadVideo(currentIndex);
    play();
  }

  function prev() {
    currentIndex = (currentIndex - 1 + videos.length) % videos.length;
    loadVideo(currentIndex);
    play();
  }

  volumeRange.addEventListener('input', () => {
    if (player) player.setVolume(volumeRange.value);
  });

  playPauseBtn.addEventListener('click', togglePlayPause);
  nextBtn.addEventListener('click', next);
  prevBtn.addEventListener('click', prev);

  // 進度條相關
  function formatTimeHMS(seconds) {
    if (isNaN(seconds)) return '00:00:00';
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }

  function updateProgress() {
    if (!player || !isPlaying) return;
    const currentTime = player.getCurrentTime();
    const duration = player.getDuration();
    if (duration) {
      const percent = (currentTime / duration) * 100;
      progress.value = percent;
      currentTimeDisplay.textContent = `${formatTimeHMS(currentTime)} / ${formatTimeHMS(duration)}`;
    }
  }

  // 拖曳跳轉影片
  let isSeeking = false;
  progress.addEventListener('input', () => {
    isSeeking = true;
    const duration = player.getDuration();
    if (!duration) return;
    const seekTo = (progress.value / 100) * duration;
    currentTimeDisplay.textContent = `${formatTimeHMS(seekTo)} / ${formatTimeHMS(duration)}`;
  });
  progress.addEventListener('change', () => {
    if (player) {
      const duration = player.getDuration();
      const seekTo = (progress.value / 100) * duration;
      player.seekTo(seekTo, true);
    }
    isSeeking = false;
  });

  setInterval(() => {
    if (!isSeeking) updateProgress();
  }, 500);

  // 自動暫停設定
  autoPauseInput.addEventListener('input', () => {
    const val = parseInt(autoPauseInput.value, 10);
    if (isNaN(val) || val < 0) {
      autoPauseSeconds = 0;
    } else {
      autoPauseSeconds = val;
    }
    resetAutoPauseTimer();
  });

  function resetAutoPauseTimer() {
    if (autoPauseTimer) clearTimeout(autoPauseTimer);
    if (autoPauseSeconds > 0 && isPlaying) {
      autoPauseTimer = setTimeout(() => {
        pause();
      }, autoPauseSeconds * 1000);
    }
  }

  // 時間顯示
  function updateTime() {
    if (isIdle) return; // 待機模式時不更新正常時間
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    const ss = String(now.getSeconds()).padStart(2, '0');
    timeElement.textContent = `⌚ 現在時間：${hh}:${mm}:${ss}`;
  }
  setInterval(updateTime, 1000);
  updateTime();

  // 全螢幕功能
  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch((err) => {
        alert(`無法進入全螢幕: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  });

  async function start() {
    videos = await fetchPlaylistVideos(PLAYLIST_ID);
    if (videos.length === 0) {
      playlistElement.innerHTML = '<li>播放清單讀取失敗</li>';
      return;
    }
    if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
      let tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      document.head.appendChild(tag);
      window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
    } else {
      onYouTubeIframeAPIReady();
    }
  }

  start();
</script>

</body>
</html>
